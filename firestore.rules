rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Helper function to determine if the user is the host of a specific quiz.
    // It now safely checks for the quiz document's existence before accessing its data.
    function isHostOfQuiz(quizId) {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/quizzes/$(quizId)) && 
             get(/databases/$(database)/documents/quizzes/$(quizId)).data.hostId == request.auth.uid;
    }

    // Helper function to identify the main host by their specific email.
    // This is a reliable way to grant special permissions.
    function isMainHost() {
      return request.auth.token.email == 'host@quiz.com';
    }

    // Rules for the 'hosts' collection.
    // Only the owner can read or write their own host document.
    match /hosts/{hostId} {
      allow read, write: if isOwner(hostId);
      allow list: if false; // Disallow listing all hosts.
    }

    // Rules for user profiles.
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Disallow listing all users for privacy.
      allow create: if isOwner(userId); // A user can create their own profile.
      allow update, delete: if isOwner(userId); // A user can update/delete their own profile.
    }

    // Rules for quizzes and their subcollections.
    match /quizzes/{quizId} {
      // Any signed-in user can read quiz data (needed for participants).
      allow read: if isSignedIn();
      // Only the user designated as the hostId in the new quiz data can create it.
      allow create: if isOwner(request.resource.data.hostId);
      // Only the established host of an existing quiz can update or delete it.
      allow update, delete: if isHostOfQuiz(quizId);

      // Rules for participants within a quiz.
      match /participants/{participantId} {
        allow read: if isSignedIn();
        allow create: if isOwner(participantId); // A user can join a quiz.
        allow update: if isOwner(participantId) || isHostOfQuiz(quizId); // Participant or host can update.
        allow delete: if isHostOfQuiz(quizId); // Only the host can remove participants.
      }

      // Rules for questions within a quiz.
      match /questions/{questionId} {
        allow read: if isSignedIn();
        allow write: if isHostOfQuiz(quizId); // Only the host can create/edit questions.
        
        // Rules for answers to a question.
        match /answers/{answerId} {
          // The participant who answered or the quiz host can view a specific answer.
          allow get: if (resource != null && isOwner(resource.data.participantId)) || isHostOfQuiz(quizId);
          // Only the host can list all answers for a question (for grading/results).
          allow list: if isHostOfQuiz(quizId);
          // A participant can create their own answer.
          allow create: if isOwner(request.resource.data.participantId);
          // Only the host can modify or delete an answer (e.g., for manual scoring).
          allow update, delete: if isHostOfQuiz(quizId);
        }
      }
    }

    // Rules for the monthly rankings.
    match /monthly_rankings/{rankingId} {
      // Anyone can read the leaderboard.
      allow read: if true;
      // Only the main host can write to the leaderboard (e.g., to reset it).
      allow write: if isMainHost();
    }

    // Rules for the app settings, like the rulebook.
    match /settings/main {
      // Any signed-in user can read the rules.
      allow read: if isSignedIn();
      // Only the main host can change the rules.
      allow write: if isMainHost();
    }
  }
}
