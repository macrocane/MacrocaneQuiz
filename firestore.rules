rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // A user is a host if a document exists for them in the /hosts collection.
    // This is the single source of truth for host status.
    function isHost(userId) {
      return exists(/databases/$(database)/documents/hosts/$(userId));
    }

    // A user is the host of a specific quiz if their UID matches the hostId in the quiz document.
    function isHostOfQuiz(quizId) {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/quizzes/$(quizId)) &&
             get(/databases/$(database)/documents/quizzes/$(quizId)).data.hostId == request.auth.uid;
    }
    
    // Special permissions for the main host account.
    function isMainHost() {
        return request.auth.token.email == 'host@quiz.com';
    }

    // --- Collection Rules ---

    // Host documents can only be read or modified by the owner.
    // Creation is handled client-side on first admin login.
    match /hosts/{hostId} {
      allow read, write: if isOwner(hostId);
    }

    // User profiles are private.
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create, update, delete: if isOwner(userId);
    }

    // Quiz documents and their subcollections.
    match /quizzes/{quizId} {
      // Any signed-in user can read quiz data (needed for participants).
      allow read: if isSignedIn();
      // Only a registered host can create a quiz.
      allow create: if isHost(request.auth.uid) && isOwner(request.resource.data.hostId);
      // Only the designated host of this specific quiz can update or delete it.
      allow update, delete: if isHostOfQuiz(quizId);

      // Rules for participants joining a quiz.
      match /participants/{participantId} {
        allow read: if isSignedIn();
        // A user can join a quiz (create their participant document).
        allow create: if isOwner(participantId);
        // A participant can update their own data, or the host can.
        allow update: if isOwner(participantId) || isHostOfQuiz(quizId);
        // Only the host can remove participants.
        allow delete: if isHostOfQuiz(quizId);
      }

      // Questions can only be managed by the quiz host.
      match /questions/{questionId} {
        allow read: if isSignedIn();
        allow write: if isHostOfQuiz(quizId);
        
        // Answers to a specific question.
        match /answers/{answerId} {
          // An answer can be seen by the participant who gave it or the quiz host.
          allow get: if (resource != null && isOwner(resource.data.participantId)) || isHostOfQuiz(quizId);
          // Only the host can list all answers for a question (for grading/results).
          allow list: if isHostOfQuiz(quizId);
          // A participant can create their own answer.
          allow create: if isOwner(request.resource.data.participantId);
          // Only the host can modify an answer (e.g., for manual scoring).
          allow update, delete: if isHostOfQuiz(quizId);
        }
      }
    }

    // Monthly rankings can be read by anyone.
    // Writing is restricted to registered hosts.
    match /monthly_rankings/{rankingId} {
      allow read: if true;
      allow write: if isHost(request.auth.uid);
    }

    // App settings, like the rulebook.
    // Reading is allowed for any signed-in user.
    // Writing is restricted to the main host email.
    match /settings/main {
      allow read: if isSignedIn();
      allow write: if isMainHost();
    }
  }
}
