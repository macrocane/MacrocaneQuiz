rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isHost() {
        return isSignedIn() && exists(/databases/$(database)/documents/hosts/$(request.auth.uid));
    }
    
    function isHostOfQuiz(quizId) {
        // Check existence before getting data to prevent errors on create.
        return exists(/databases/$(database)/documents/quizzes/$(quizId)) &&
               get(/databases/$(database)/documents/quizzes/$(quizId)).data.hostId == request.auth.uid;
    }

    // --- Collection Rules ---

    // Host documents can be read by anyone, but only created/modified by the owner.
    match /hosts/{hostId} {
      allow read: if true;
      allow write: if isOwner(hostId);
    }

    // User profiles are private.
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create, update, delete: if isOwner(userId);
    }

    // Quiz documents and their subcollections.
    match /quizzes/{quizId} {
      // Any user can read quiz data.
      allow read: if true;
      // A quiz can be created by a user who is a registered host.
      allow create: if isHost() && isOwner(request.resource.data.hostId);
      // The host of the quiz can update or delete it.
      allow update, delete: if isHostOfQuiz(quizId);

      // Rules for participants joining a quiz.
      match /participants/{participantId} {
        // Participant data is public within a quiz context.
        allow read: if true;
        // A user can join a quiz (create their participant document).
        allow create: if isOwner(participantId);
        // A participant can update their own data, or the host can.
        allow update: if isOwner(participantId) || isHostOfQuiz(quizId);
        // Only the host can remove participants.
        allow delete: if isHostOfQuiz(quizId);
      }

      // Questions can be read by anyone, but only managed by the quiz host.
      match /questions/{questionId} {
        allow read: if true;
        allow write: if isHostOfQuiz(quizId);
        
        // Answers to a specific question.
        match /answers/{answerId} {
          // All answers are public to read.
          allow read: if true;
          // A participant can create their own answer.
          allow create: if isOwner(request.resource.data.participantId);
          // Only the host can modify an answer (e.g., for manual scoring).
          allow update, delete: if isHostOfQuiz(quizId);
        }
      }
    }

    // Monthly rankings can be read by anyone.
    // Writing is restricted to registered hosts.
    match /monthly_rankings/{rankingId} {
      allow read: if true;
      allow write: if isHost();
    }

    // App settings, like the rulebook. Reading is public. Writing is for hosts.
    match /settings/main {
      allow read: if true;
      allow write: if isHost();
    }
  }
}
